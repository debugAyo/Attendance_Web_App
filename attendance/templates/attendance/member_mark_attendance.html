{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - RollCall</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <style>
      body {
        background-image: url("{% static 'images/hands-together-unity.jpg' %}");
        background-size: 80vw auto;
        background-repeat: no-repeat;
        background-position: center top;
        min-height: 100vh;
      }
      #suggestions {
        position: absolute;
        width: 100%;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 10px 10px;
        background-color: white;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      #suggestions .list-group-item {
        border: none;
        padding: 0.75rem 1rem;
        color: #333;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      #suggestions .list-group-item:hover {
        background-color: #f8f9fa;
      }
      #suggestions .list-group-item small {
        color: #666;
      }
      #id_name[readonly], #id_phone[readonly] {
        background-color: #e9ecef;
      }
      
      /* Corner Mini Logo */
      .corner-logo {
        position: absolute;
        top: 20px;
        left: 20px;
        z-index: 2000;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      
      .corner-logo-svg {
        width: 50px;
        height: 50px;
        filter: drop-shadow(0 4px 12px rgba(102, 126, 234, 0.5));
        animation: cornerLogoFloat 3s ease-in-out infinite;
      }
      
      .corner-logo-text {
        font-size: 1.2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-shadow: none;
      }
      
      @keyframes cornerLogoFloat {
        0%, 100% { transform: translateY(0) rotate(0deg); }
        50% { transform: translateY(-3px) rotate(2deg); }
      }
      
      /* Hide corner logo on mobile since it appears in the form */
      @media (max-width: 768px) {
        .corner-logo {
          display: none;
        }
      }
    </style>
</head>
<body>
  <!-- Modern Corner Logo -->
  <div class="corner-logo">
    <svg class="corner-logo-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
      <defs>
        <linearGradient id="cornerLogoGrad" x1="0%" y1="0%" x2="100%" y2="100%">
          <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
          <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
        </linearGradient>
        <filter id="cornerGlow" x="-20%" y="-20%" width="140%" height="140%">
          <feDropShadow dx="0" dy="2" stdDeviation="3" flood-color="rgba(102, 126, 234, 0.4)"/>
        </filter>
      </defs>
      <circle cx="60" cy="60" r="52" fill="url(#cornerLogoGrad)" filter="url(#cornerGlow)"/>
      <g fill="white">
        <rect x="38" y="35" width="44" height="54" rx="5" fill="none" stroke="white" stroke-width="3"/>
        <rect x="50" y="29" width="20" height="10" rx="2" fill="white"/>
        <line x1="45" y1="52" x2="53" y2="52" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        <polyline points="57,50 60,53 67,46" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="45" y1="64" x2="53" y2="64" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        <polyline points="57,62 60,65 67,58" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
        <line x1="45" y1="76" x2="53" y2="76" stroke="white" stroke-width="2.5" stroke-linecap="round"/>
        <polyline points="57,74 60,77 67,70" fill="none" stroke="#4ade80" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      </g>
    </svg>
    <span class="corner-logo-text">RollCall</span>
  </div>
  
  <div class="auth-container">
        <div class="auth-info-panel">
            <div class="logo-container">
                <svg class="logo-svg" viewBox="0 0 120 120" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
                        </linearGradient>
                        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                            <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
                            <feMerge>
                                <feMergeNode in="coloredBlur"/>
                                <feMergeNode in="SourceGraphic"/>
                            </feMerge>
                        </filter>
                        <filter id="shadow" x="-20%" y="-20%" width="140%" height="140%">
                            <feDropShadow dx="0" dy="4" stdDeviation="6" flood-color="rgba(102, 126, 234, 0.4)"/>
                        </filter>
                    </defs>
                    <circle class="logo-ring" cx="60" cy="60" r="54" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
                    <circle class="logo-bg" cx="60" cy="60" r="48" fill="url(#logoGradient)" filter="url(#shadow)"/>
                    <g class="logo-icon" fill="white" filter="url(#glow)">
                        <rect x="35" y="32" width="50" height="62" rx="6" fill="none" stroke="white" stroke-width="3"/>
                        <rect x="48" y="26" width="24" height="12" rx="3" fill="white"/>
                        <line x1="42" y1="52" x2="52" y2="52" stroke="white" stroke-width="3" stroke-linecap="round" class="check-line line-1"/>
                        <polyline points="56,50 60,54 68,46" fill="none" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="checkmark check-1"/>
                        <line x1="42" y1="66" x2="52" y2="66" stroke="white" stroke-width="3" stroke-linecap="round" class="check-line line-2"/>
                        <polyline points="56,64 60,68 68,60" fill="none" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="checkmark check-2"/>
                        <line x1="42" y1="80" x2="52" y2="80" stroke="white" stroke-width="3" stroke-linecap="round" class="check-line line-3"/>
                        <polyline points="56,78 60,82 68,74" fill="none" stroke="#4ade80" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" class="checkmark check-3"/>
                    </g>
                    <circle class="particle p1" cx="20" cy="30" r="3" fill="rgba(255,255,255,0.6)"/>
                    <circle class="particle p2" cx="100" cy="40" r="2" fill="rgba(255,255,255,0.5)"/>
                    <circle class="particle p3" cx="95" cy="90" r="2.5" fill="rgba(255,255,255,0.7)"/>
                    <circle class="particle p4" cx="25" cy="85" r="2" fill="rgba(255,255,255,0.5)"/>
                </svg>
                <span class="logo-text">RollCall</span>
            </div>
            <h1>Mark Your Attendance</h1>
            <p>Welcome back! Mark your attendance today and stay connected with your organization.</p>
            
       </div>
        <!-- Removed stray logo div -->
        <div class="auth-form-panel">
            <div class="auth-form-wrapper signup">
                <h2>Mark Attendance</h2>
                <p class="subtitle">
                    First time here? <a href="{% url 'signup' %}">Register now</a>
                </p>

                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-success" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                {% if form.fields.service.queryset.count == 0 %}
                  <div class="alert alert-warning text-center">
                    <strong>No Sessions Available</strong><br>
                    Please contact an admin to set up sessions.
                  </div>
                {% else %}
                  <form method="post" novalidate id="attendanceForm">
                    {% csrf_token %}
                    
                    <div class="form-group position-relative">
                      <label for="id_name_search">Search Your Name or Phone*</label>
                      <input 
                        type="text" 
                        id="id_name_search" 
                        class="form-control" 
                        placeholder="Start typing your name or phone number..."
                        autocomplete="off"
                        {% if prefill_name %}value="{{ prefill_name }}"{% endif %}>
                      <div id="suggestions" class="list-group"></div>
                      <small class="form-text text-muted" style="font-size: 0.8rem;">
                        üí° Select yourself from the list or click "I'm New" below
                      </small>
                    </div>
                    
                    <!-- Hidden fields that get auto-filled -->
                    <input type="hidden" name="name" id="id_name" value="{% if prefill_name %}{{ prefill_name }}{% endif %}" required>
                    <input type="hidden" name="phone" id="id_phone" value="{% if prefill_phone %}{{ prefill_phone }}{% endif %}" required>
                    
                    <!-- GPS Location fields -->
                    <input type="hidden" name="device_latitude" id="device_latitude">
                    <input type="hidden" name="device_longitude" id="device_longitude">
                    <input type="hidden" name="gps_accuracy" id="gps_accuracy">
                    
                    <!-- Location Status Indicator -->
                    <div id="locationStatus" class="location-status" style="padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                      <div class="d-flex align-items-center">
                        <span id="locationIcon" style="margin-right: 10px; font-size: 1.2rem;">üìç</span>
                        <div>
                          <div id="locationText" style="font-weight: 500;">Detecting your location...</div>
                          <small id="locationDetails" style="color: #666;"></small>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Display selected user info -->
                    {% if prefill_name %}
                    <div id="selectedMember" style="padding: 1rem; background: #e8f5e9; border-radius: 8px; margin-bottom: 1rem;">
                    {% else %}
                    <div id="selectedMember" style="display:none; padding: 1rem; background: #e8f5e9; border-radius: 8px; margin-bottom: 1rem;">
                    {% endif %}
                      <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                          <strong style="color: #2e7d32;">‚úì Selected:</strong>
                          <div id="selectedName" style="font-weight: 500; color: #333;">{% if prefill_name %}{{ prefill_name }}{% endif %}</div>
                          <small id="selectedPhone" style="color: #666;">{% if prefill_phone %}{{ prefill_phone }}{% endif %}</small>
                        </div>
                        <button type="button" id="clearBtn" class="btn btn-sm btn-outline-secondary">Change</button>
                      </div>
                    </div>
                    
                    <div class="form-group">
                      <label for="id_service">Session*</label>
                      {{ form.service }}
                    </div>
                    
                    <div class="form-group">
                      <label for="id_service_code">Session Code*</label>
                      {{ form.service_code }}
                      <small class="form-text text-muted" style="font-size: 0.8rem;">Ask an admin for today's session code</small>
                    </div>
                    
                    <button type="submit" class="btn-submit" id="submitBtn">
                      Mark My Attendance
                    </button>
                    
                    <button type="button" class="btn-submit" id="newMemberBtn" style="display: none; background-color: #6c757d; margin-top: 10px;">
                      I'm New - Register First
                    </button>
                  </form>
                  
                  <div class="form-footer">
                    <p>Admin? <a href="{% url 'login' %}">Login here</a></p>
                  </div>
                {% endif %}
            </div>
        </div>
    </div>

<script>
  let debounceTimer;
  const searchInput = document.getElementById('id_name_search');
  const nameInput = document.getElementById('id_name');
  const phoneInput = document.getElementById('id_phone');
  const suggestionsDiv = document.getElementById('suggestions');
  const submitBtn = document.getElementById('submitBtn');
  const newMemberBtn = document.getElementById('newMemberBtn');
  const selectedMemberDiv = document.getElementById('selectedMember');
  const selectedNameDiv = document.getElementById('selectedName');
  const selectedPhoneDiv = document.getElementById('selectedPhone');
  const clearBtn = document.getElementById('clearBtn');

  // Function to show selected member
  function selectMember(name, phone) {
    nameInput.value = name;
    phoneInput.value = phone;
    selectedNameDiv.textContent = name;
    selectedPhoneDiv.textContent = phone;
    selectedMemberDiv.style.display = 'block';
    searchInput.value = '';
    suggestionsDiv.style.display = 'none';
    submitBtn.disabled = false;
  }

  // Clear selection
  clearBtn.addEventListener('click', function() {
    nameInput.value = '';
    phoneInput.value = '';
    selectedMemberDiv.style.display = 'none';
    searchInput.value = '';
    searchInput.focus();
  });

  searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();

    if (query.length < 2) {
      suggestionsDiv.style.display = 'none';
      newMemberBtn.style.display = 'none';
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`/api/search-members/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(function(data) {
          suggestionsDiv.innerHTML = '';
          if (data.members.length === 0) {
            suggestionsDiv.innerHTML = '<div class="list-group-item text-muted">No users found. Click "I\'m New" below.</div>';
            newMemberBtn.style.display = 'block';
          } else {
            newMemberBtn.style.display = 'none';
            data.members.forEach(function(member) {
              const item = document.createElement('div');
              item.className = 'list-group-item list-group-item-action';
              item.innerHTML = `<div style="color: #333; font-weight: 500;">${member.name}</div><small style="color: #666;">${member.phone}</small>`;
              item.onclick = function() {
                selectMember(member.name, member.phone);
              };
              suggestionsDiv.appendChild(item);
            });
          }
          suggestionsDiv.style.display = 'block';
        })
        .catch(function(error) {
          console.error('Error fetching members:', error);
        });
    }, 300);
  });

  newMemberBtn.addEventListener('click', function() {
    window.location.href = "{% url 'signup' %}";
  });

  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.style.display = 'none';
    }
  });
  
  // Auto-reset form after successful submission (only for returning users, not new signups)
  {% if messages and not prefill_name %}
  setTimeout(function() {
    document.getElementById('attendanceForm').reset();
    document.getElementById('id_name_search').focus();
  }, 3000);
  {% endif %}
  
  // GPS Location Detection
  const locationStatus = document.getElementById('locationStatus');
  const locationIcon = document.getElementById('locationIcon');
  const locationText = document.getElementById('locationText');
  const locationDetails = document.getElementById('locationDetails');
  const deviceLat = document.getElementById('device_latitude');
  const deviceLng = document.getElementById('device_longitude');
  const gpsAccuracy = document.getElementById('gps_accuracy');
  
  // Google Maps API Key (from Django settings)
  const GOOGLE_API_KEY = '{{ google_maps_api_key }}';
  
  // GPS Configuration for high precision (¬±5m target)
  const GPS_CONFIG = {
    targetAccuracy: 10,        // Target accuracy in meters (aim for ‚â§10m)
    maxAttempts: 15,           // Maximum number of position readings
    maxWaitTime: 30000,        // Maximum time to wait (30 seconds)
    minReadings: 3,            // Minimum readings before accepting
    acceptableAccuracy: 20     // Accept if we get this accuracy
  };
  
  let watchId = null;
  let positionReadings = [];
  let bestPosition = null;
  let gpsStartTime = null;
  let vpnDetected = false;
  
  function updateLocationUI(status, icon, text, details, bgColor) {
    locationIcon.textContent = icon;
    locationText.textContent = text;
    locationDetails.textContent = details || '';
    locationStatus.style.backgroundColor = bgColor;
    locationStatus.style.border = '1px solid ' + (bgColor === '#d4edda' ? '#28a745' : bgColor === '#fff3cd' ? '#ffc107' : bgColor === '#f8d7da' ? '#dc3545' : '#e9ecef');
  }
  
  function stopWatching() {
    if (watchId !== null) {
      navigator.geolocation.clearWatch(watchId);
      watchId = null;
    }
  }
  
  // VPN/Proxy Detection
  async function checkVPNStatus() {
    try {
      // Use multiple methods to detect VPN/proxy
      const response = await fetch('/api/check-vpn/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
      });
      const data = await response.json();
      
      if (data.is_vpn || data.is_proxy || data.is_hosting) {
        vpnDetected = true;
        showVPNWarning(data);
        return true;
      }
    } catch (e) {
      console.log('VPN check failed:', e);
    }
    return false;
  }
  
  function showVPNWarning(data) {
    const warningDiv = document.createElement('div');
    warningDiv.className = 'alert alert-danger mt-3';
    warningDiv.id = 'vpn-warning';
    warningDiv.innerHTML = `
      <strong>‚ö†Ô∏è VPN/Proxy Detected!</strong><br>
      <small>Please disable your VPN or proxy to mark attendance. Your real location is required for attendance verification.</small>
      <br><small class="text-muted">Detected: ${data.reason || 'VPN/Proxy connection'}</small>
    `;
    
    // Insert warning after location status
    const existingWarning = document.getElementById('vpn-warning');
    if (existingWarning) existingWarning.remove();
    locationStatus.parentNode.insertBefore(warningDiv, locationStatus.nextSibling);
    
    // Disable submit button
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.textContent = 'Disable VPN to Continue';
      submitBtn.style.backgroundColor = '#6c757d';
    }
  }
  
  // Google Maps Geolocation API (WiFi + Cell triangulation for better indoor accuracy)
  async function getGoogleGeolocation() {
    if (!GOOGLE_API_KEY) return null;
    
    try {
      const response = await fetch(`https://www.googleapis.com/geolocation/v1/geolocate?key=${GOOGLE_API_KEY}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          considerIp: false,  // Don't use IP (can be VPN)
          wifiAccessPoints: [], // Browser will auto-fill if available
          cellTowers: []
        })
      });
      
      if (response.ok) {
        const data = await response.json();
        if (data.location) {
          return {
            lat: data.location.lat,
            lng: data.location.lng,
            accuracy: data.accuracy || 50,
            source: 'google'
          };
        }
      }
    } catch (e) {
      console.log('Google Geolocation failed:', e);
    }
    return null;
  }
  
  function applyBestPosition() {
    if (bestPosition) {
      deviceLat.value = bestPosition.lat.toFixed(7);
      deviceLng.value = bestPosition.lng.toFixed(7);
      gpsAccuracy.value = bestPosition.accuracy.toFixed(2);
      
      let accuracyText = bestPosition.accuracy <= 5 ? 'Excellent (¬±5m)' : 
                         bestPosition.accuracy <= 10 ? 'Very High (¬±10m)' :
                         bestPosition.accuracy <= 20 ? 'High (¬±20m)' : 
                         bestPosition.accuracy <= 50 ? 'Medium (¬±50m)' : 'Low';
      let bgColor = bestPosition.accuracy <= 10 ? '#d4edda' : 
                    bestPosition.accuracy <= 30 ? '#d1ecf1' : '#fff3cd';
      
      let sourceText = bestPosition.source === 'google' ? ' (WiFi-enhanced)' : '';
      updateLocationUI('success', '‚úÖ', 'Location locked!', 
        `GPS: ${bestPosition.lat.toFixed(6)}, ${bestPosition.lng.toFixed(6)} (${accuracyText}: ${Math.round(bestPosition.accuracy)}m)${sourceText}`, bgColor);
      
      // Try to get address using reverse geocoding
      fetch(`https://nominatim.openstreetmap.org/reverse?lat=${bestPosition.lat}&lon=${bestPosition.lng}&format=json`)
        .then(res => res.json())
        .then(data => {
          if (data && data.display_name) {
            const parts = data.display_name.split(',');
            const shortAddress = parts.slice(0, 3).join(',');
            locationDetails.textContent = shortAddress + ` (${accuracyText}: ${Math.round(bestPosition.accuracy)}m)`;
          }
        })
        .catch(() => {});
    }
  }
  
  function processPosition(position) {
    const lat = position.coords.latitude;
    const lng = position.coords.longitude;
    const accuracy = position.coords.accuracy;
    const timestamp = position.timestamp;
    
    positionReadings.push({ lat, lng, accuracy, timestamp, source: 'gps' });
    
    // Track best (most accurate) position
    if (!bestPosition || accuracy < bestPosition.accuracy) {
      bestPosition = { lat, lng, accuracy, timestamp, source: 'gps' };
    }
    
    const elapsed = Date.now() - gpsStartTime;
    const readingCount = positionReadings.length;
    
    // Update UI with progress
    let progressText = `Reading ${readingCount}/${GPS_CONFIG.maxAttempts}... Best: ${Math.round(bestPosition.accuracy)}m`;
    updateLocationUI('loading', 'üì°', 'Refining GPS accuracy...', progressText, '#e9ecef');
    
    // Check if we should stop
    const shouldStop = 
      // Got excellent accuracy (‚â§ target)
      accuracy <= GPS_CONFIG.targetAccuracy ||
      // Got acceptable accuracy with enough readings
      (accuracy <= GPS_CONFIG.acceptableAccuracy && readingCount >= GPS_CONFIG.minReadings) ||
      // Max attempts reached
      readingCount >= GPS_CONFIG.maxAttempts ||
      // Timeout reached
      elapsed >= GPS_CONFIG.maxWaitTime;
    
    if (shouldStop) {
      stopWatching();
      applyBestPosition();
    }
  }
  
  async function getGPSLocation() {
    if (!navigator.geolocation) {
      updateLocationUI('error', '‚ö†Ô∏è', 'GPS not supported', 'Your browser doesn\'t support GPS. IP location will be used.', '#fff3cd');
      return;
    }
    
    // Reset state
    positionReadings = [];
    bestPosition = null;
    gpsStartTime = Date.now();
    stopWatching();
    
    // Check for VPN first
    updateLocationUI('loading', 'üîí', 'Checking connection...', 'Verifying network security', '#e9ecef');
    await checkVPNStatus();
    
    if (vpnDetected) {
      updateLocationUI('error', 'üö´', 'VPN Detected', 'Please disable VPN to mark attendance', '#f8d7da');
      return;
    }
    
    updateLocationUI('loading', 'üõ∞Ô∏è', 'Acquiring GPS signal...', 'Please allow location access. This may take up to 30 seconds for best accuracy.', '#e9ecef');
    
    // Try Google Geolocation API first for WiFi-enhanced positioning
    if (GOOGLE_API_KEY) {
      const googlePos = await getGoogleGeolocation();
      if (googlePos && googlePos.accuracy <= 30) {
        bestPosition = googlePos;
        updateLocationUI('loading', 'üì∂', 'WiFi location acquired', `Refining with GPS... (Current: ${Math.round(googlePos.accuracy)}m)`, '#e9ecef');
      }
    }
    
    // Use watchPosition for continuous tracking to get best accuracy
    watchId = navigator.geolocation.watchPosition(
      processPosition,
      function(error) {
        stopWatching();
        
        // If we have any position (including from Google), use it
        if (bestPosition) {
          applyBestPosition();
          return;
        }
        
        let errorMsg = 'Location access denied';
        let errorDetail = 'IP-based location will be used instead';
        
        switch(error.code) {
          case error.PERMISSION_DENIED:
            errorMsg = 'Location access denied';
            errorDetail = 'Please enable location in browser settings for accurate tracking';
            break;
          case error.POSITION_UNAVAILABLE:
            errorMsg = 'GPS signal unavailable';
            errorDetail = 'Move to an open area with clear sky view and try again';
            break;
          case error.TIMEOUT:
            errorMsg = 'GPS timeout';
            errorDetail = 'Could not get precise location. Tap to retry.';
            break;
        }
        
        updateLocationUI('error', '‚ö†Ô∏è', errorMsg, errorDetail, '#fff3cd');
      },
      {
        enableHighAccuracy: true,    // Forces GPS/GNSS over WiFi/Cell
        timeout: 15000,              // 15 second timeout per reading
        maximumAge: 0                // Always get fresh position (no cache)
      }
    );
    
    // Safety timeout - stop after maxWaitTime even if still getting readings
    setTimeout(() => {
      if (watchId !== null) {
        stopWatching();
        if (bestPosition) {
          applyBestPosition();
        } else {
          updateLocationUI('error', '‚ö†Ô∏è', 'GPS timeout', 'Could not get precise location. Tap to retry.', '#fff3cd');
        }
      }
    }, GPS_CONFIG.maxWaitTime + 1000);
  }
  
  // Get GPS location on page load
  getGPSLocation();
  
  // Allow manual retry by clicking on location status
  locationStatus.style.cursor = 'pointer';
  locationStatus.addEventListener('click', function() {
    if (!vpnDetected) {
      getGPSLocation();
    } else {
      // Re-check VPN status
      vpnDetected = false;
      document.getElementById('vpn-warning')?.remove();
      const submitBtn = document.querySelector('button[type="submit"]');
      if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = 'Mark Attendance';
        submitBtn.style.backgroundColor = '';
      }
      getGPSLocation();
    }
  });
  
  // Refresh GPS location before form submission
  document.getElementById('attendanceForm').addEventListener('submit', function(e) {
    // Block if VPN detected
    if (vpnDetected) {
      e.preventDefault();
      alert('Please disable your VPN/proxy to mark attendance.');
      return false;
    }
    
    // If no GPS coordinates yet or low accuracy, try one more quick read
    if (!deviceLat.value || (gpsAccuracy.value && parseFloat(gpsAccuracy.value) > 50)) {
      e.preventDefault();
      
      updateLocationUI('loading', 'üîÑ', 'Final location check...', 'Verifying GPS before submission', '#e9ecef');
      
      navigator.geolocation.getCurrentPosition(
        function(pos) {
          const accuracy = pos.coords.accuracy;
          // Only update if this reading is better
          if (!bestPosition || accuracy < bestPosition.accuracy) {
            deviceLat.value = pos.coords.latitude.toFixed(7);
            deviceLng.value = pos.coords.longitude.toFixed(7);
            gpsAccuracy.value = accuracy.toFixed(2);
          }
          // Submit the form
          e.target.submit();
        },
        function() {
          // Submit anyway with existing data
          e.target.submit();
        },
        { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
      );
    }
  });
  
  // Cleanup when leaving page
  window.addEventListener('beforeunload', stopWatching);
</script>

</body>
</html>
