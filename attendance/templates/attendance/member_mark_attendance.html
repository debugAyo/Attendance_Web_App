{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mark Attendance - RollCall</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'css/login.css' %}">
    <style>
      #suggestions {
        position: absolute;
        width: 100%;
        z-index: 1000;
        max-height: 200px;
        overflow-y: auto;
        display: none;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 10px 10px;
      }
      #suggestions .list-group-item {
        border: none;
        padding: 0.75rem 1rem;
      }
      #suggestions a:hover {
        background-color: #f8f9fa;
      }
      #id_name[readonly], #id_phone[readonly] {
        background-color: #e9ecef;
      }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="auth-info-panel">
            <div class="logo">
                <i class="fa fa-check-to-slot"></i>
                <span>RollCall</span>
            </div>
            <h1>Mark Your Attendance</h1>
            <p>Welcome back! Quickly mark your attendance for today's service to stay connected with our church community.</p>
            
        </div>
        <div class="auth-form-panel">
            <div class="auth-form-wrapper signup">
                <h2>Church Attendance</h2>
                <p class="subtitle">
                    First time here? <a href="{% url 'signup' %}">Register as a member</a>
                </p>

                {% if messages %}
                    {% for message in messages %}
                        <div class="alert alert-success" role="alert">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}

                {% if form.fields.service.queryset.count == 0 %}
                  <div class="alert alert-warning text-center">
                    <strong>No Services Available</strong><br>
                    Please contact an admin to set up church services.
                  </div>
                {% else %}
                  <form method="post" novalidate id="attendanceForm">
                    {% csrf_token %}
                    
                    <div class="form-group position-relative">
                      <label for="id_name_search">Search Your Name*</label>
                      <input 
                        type="text" 
                        id="id_name_search" 
                        class="form-control" 
                        placeholder="Type your name or phone number..."
                        autocomplete="off"
                        {% if prefill_name %}value="{{ prefill_name }}"{% endif %}>
                      <div id="suggestions" class="list-group"></div>
                      <small class="form-text text-muted" style="font-size: 0.8rem;">ðŸ’¡ Start typing to see suggestions</small>
                    </div>
                    
                    <div class="form-group">
                      <label for="id_name">Full Name*</label>
                      <input type="text" name="name" id="id_name" class="form-control" value="{% if prefill_name %}{{ prefill_name }}{% endif %}" required readonly>
                    </div>
                    
                    <div class="form-group">
                      <label for="id_phone">Phone Number*</label>
                      <input type="text" name="phone" id="id_phone" class="form-control" value="{% if prefill_phone %}{{ prefill_phone }}{% endif %}" required readonly>
                    </div>
                    
                    <div class="form-group">
                      <label for="id_service">Church Service*</label>
                      {{ form.service }}
                    </div>
                    
                    <div class="form-group">
                      <label for="id_service_code">Service Code*</label>
                      {{ form.service_code }}
                      <small class="form-text text-muted" style="font-size: 0.8rem;">Ask an admin for today's service code</small>
                    </div>
                    
                    <button type="submit" class="btn-submit" id="submitBtn" {% if not prefill_name %}disabled{% endif %}>
                      Mark My Attendance
                    </button>
                    
                    <button type="button" class="btn-submit" id="newMemberBtn" style="display: none; background-color: #6c757d; margin-top: 10px;">
                      I'm a New Member - Register First
                    </button>
                  </form>
                  
                  <div class="form-footer">
                    <p>Admin? <a href="{% url 'login' %}">Login here</a></p>
                  </div>
                {% endif %}
            </div>
        </div>
    </div>

<script>
  let debounceTimer;
  const searchInput = document.getElementById('id_name_search');
  const nameInput = document.getElementById('id_name');
  const phoneInput = document.getElementById('id_phone');
  const suggestionsDiv = document.getElementById('suggestions');
  const submitBtn = document.getElementById('submitBtn');
  const newMemberBtn = document.getElementById('newMemberBtn');

  searchInput.addEventListener('input', function() {
    clearTimeout(debounceTimer);
    const query = this.value.trim();

    if (query.length < 2) {
      suggestionsDiv.style.display = 'none';
      return;
    }

    debounceTimer = setTimeout(() => {
      fetch(`/api/search-members/?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          suggestionsDiv.innerHTML = '';
          
          if (data.members.length === 0) {
            suggestionsDiv.innerHTML = '<div class="list-group-item text-muted">No members found. Click "I\'m a New Member" below.</div>';
            newMemberBtn.style.display = 'block';
          } else {
            newMemberBtn.style.display = 'none';
            data.members.forEach(member => {
              const item = document.createElement('a');
              item.href = '#';
              item.className = 'list-group-item list-group-item-action';
              item.innerHTML = `<div>${member.name}</div><small class="text-muted">${member.phone}</small>`;
              item.onclick = (e) => {
                e.preventDefault();
                nameInput.value = member.name;
                phoneInput.value = member.phone;
                searchInput.value = member.name;
                suggestionsDiv.style.display = 'none';
                submitBtn.disabled = false;
              };
              suggestionsDiv.appendChild(item);
            });
          }
          suggestionsDiv.style.display = 'block';
        })
        .catch(error => {
          console.error('Error fetching members:', error);
        });
    }, 300);
  });

  newMemberBtn.addEventListener('click', function() {
    window.location.href = "{% url 'signup' %}";
  });

  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !suggestionsDiv.contains(e.target)) {
      suggestionsDiv.style.display = 'none';
    }
  });
  {% if messages %}
  setTimeout(() => {
    document.getElementById('attendanceForm').reset();
    document.getElementById('id_name').setAttribute('readonly', true);
    document.getElementById('id_phone').setAttribute('readonly', true);
    document.getElementById('submitBtn').disabled = true;
    document.getElementById('id_name_search').focus();
  }, 3000);
  {% endif %}
</script>

</body>
</html>
