{% extends 'base.html' %}

{% block title %}Login History - {{ target_user.username }}{% endblock %}

{% block extra_css %}
<style>
    .suspicious-alert {
        background-color: #fff3cd;
        border-left: 4px solid #ffc107;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'admin_geolocation' %}">Geolocation Dashboard</a></li>
            <li class="breadcrumb-item active">{{ target_user.username }}</li>
        </ol>
    </nav>

    <!-- User Header -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-auto">
                    <div class="bg-primary bg-opacity-10 rounded-circle p-4">
                        <i class="fas fa-user-shield fa-2x text-primary"></i>
                    </div>
                </div>
                <div class="col">
                    <h3 class="mb-1">{{ target_user.username }}</h3>
                    <p class="text-muted mb-0">
                        {% if target_user.email %}
                        <i class="fas fa-envelope me-2"></i>{{ target_user.email }}
                        {% endif %}
                        {% if target_user.is_superuser %}
                        <span class="badge bg-danger ms-2">Superuser</span>
                        {% else %}
                        <span class="badge bg-primary ms-2">Admin</span>
                        {% endif %}
                    </p>
                </div>
                <div class="col-auto">
                    <div class="text-center">
                        <h2 class="mb-0 text-primary">{{ total_logins }}</h2>
                        <small class="text-muted">Total Logins</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Suspicious Activity Alert -->
    {% if suspicious_activity %}
    <div class="suspicious-alert p-4 mb-4">
        <h5 class="mb-3">
            <i class="fas fa-exclamation-triangle text-warning"></i> 
            Suspicious Activity Detected
        </h5>
        <p class="mb-2">The following logins occurred from different cities within a short time period:</p>
        <div class="table-responsive">
            <table class="table table-sm table-borderless mb-0">
                <thead>
                    <tr>
                        <th>Previous Login</th>
                        <th>Current Login</th>
                        <th>Time Difference</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in suspicious_activity %}
                    <tr>
                        <td>
                            <strong>{{ item.previous.geolocation.city }}</strong>, {{ item.previous.geolocation.country }}
                            <br><small>{{ item.previous.login_time|date:"M d, H:i" }}</small>
                        </td>
                        <td>
                            <strong>{{ item.current.geolocation.city }}</strong>, {{ item.current.geolocation.country }}
                            <br><small>{{ item.current.login_time|date:"M d, H:i" }}</small>
                        </td>
                        <td>
                            <span class="badge bg-warning text-dark">{{ item.time_diff_minutes }} minutes</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <small class="text-muted mt-2 d-block">
            <i class="fas fa-info-circle"></i> This could indicate VPN usage, shared credentials, or account compromise.
        </small>
    </div>
    {% endif %}

    <div class="row">
        <!-- Unique Locations -->
        <div class="col-md-4 mb-4">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-map-marker-alt text-danger"></i> Login Locations
                    </h5>
                </div>
                <div class="card-body">
                    {% if unique_locations %}
                    <div class="list-group list-group-flush">
                        {% for loc in unique_locations %}
                        <div class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <div>
                                <strong>{{ loc.geolocation__city|default:"Unknown" }}</strong>
                                <br><small class="text-muted">{{ loc.geolocation__country }}</small>
                            </div>
                            <span class="badge bg-primary rounded-pill">{{ loc.count }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-muted text-center mb-0">
                        <i class="fas fa-map-marker-alt fa-2x mb-2"></i><br>
                        No location data available
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Login History -->
        <div class="col-md-8 mb-4">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-history text-info"></i> Login History
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive" style="max-height: 500px;">
                        <table class="table table-hover mb-0">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Location</th>
                                    <th>IP Address</th>
                                    <th>ISP</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for login in logins %}
                                <tr {% if login.geolocation.is_proxy %}class="table-warning"{% endif %}>
                                    <td>
                                        <strong>{{ login.login_time|date:"M d, Y" }}</strong>
                                        <br><small class="text-muted">{{ login.login_time|time:"H:i:s" }}</small>
                                    </td>
                                    <td>
                                        {% if login.device_latitude and login.device_longitude %}
                                        <i class="fas fa-crosshairs text-success me-1" title="GPS Location"></i>
                                        <strong>GPS Verified</strong>
                                        <br>
                                        <small class="text-muted">
                                            <a href="https://www.google.com/maps?q={{ login.device_latitude }},{{ login.device_longitude }}" 
                                               target="_blank" class="text-decoration-none">
                                                {{ login.device_latitude|floatformat:5 }}, {{ login.device_longitude|floatformat:5 }}
                                                <i class="fas fa-external-link-alt ms-1"></i>
                                            </a>
                                        </small>
                                        {% if login.gps_accuracy %}
                                        <br><small class="text-info">Â±{{ login.gps_accuracy|floatformat:0 }}m accuracy</small>
                                        {% endif %}
                                        {% elif login.geolocation %}
                                        <i class="fas fa-map-marker-alt text-danger me-1"></i>
                                        {{ login.geolocation.city|default:"Unknown" }}, {{ login.geolocation.country|default:"" }}
                                        {% if login.geolocation.region_name %}
                                        <br><small class="text-muted">{{ login.geolocation.region_name }}</small>
                                        {% endif %}
                                        {% if login.geolocation.latitude and login.geolocation.longitude %}
                                        <br><small class="text-muted">
                                            <a href="https://www.google.com/maps?q={{ login.geolocation.latitude }},{{ login.geolocation.longitude }}" 
                                               target="_blank" class="text-decoration-none">
                                                Approx: {{ login.geolocation.latitude|floatformat:4 }}, {{ login.geolocation.longitude|floatformat:4 }}
                                                <i class="fas fa-external-link-alt ms-1"></i>
                                            </a>
                                        </small>
                                        {% endif %}
                                        {% else %}
                                        <span class="text-muted">Local/Private IP</span>
                                        {% endif %}
                                    </td>
                                    <td><code class="small">{{ login.ip_address }}</code></td>
                                    <td>
                                        {% if login.geolocation %}
                                        <small>{{ login.geolocation.isp|truncatechars:25 }}</small>
                                        {% else %}
                                        <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if login.is_successful %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-check"></i> Success
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger">
                                            <i class="fas fa-times"></i> Failed
                                        </span>
                                        {% endif %}
                                        
                                        {% if login.geolocation.is_proxy %}
                                        <span class="badge bg-warning text-dark ms-1" title="VPN/Proxy detected">
                                            <i class="fas fa-mask"></i>
                                        </span>
                                        {% endif %}
                                        
                                        {% if login.geolocation.is_mobile %}
                                        <span class="badge bg-info ms-1" title="Mobile device">
                                            <i class="fas fa-mobile-alt"></i>
                                        </span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-4">
                                        <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                        No login records yet
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Agent Info -->
    {% if logins %}
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-header bg-white border-0">
            <h5 class="mb-0">
                <i class="fas fa-laptop text-secondary"></i> Recent Device Info
            </h5>
        </div>
        <div class="card-body">
            {% with logins.first as latest %}
            {% if latest.user_agent %}
            <code class="small text-break">{{ latest.user_agent }}</code>
            {% else %}
            <span class="text-muted">No user agent data available</span>
            {% endif %}
            {% endwith %}
        </div>
    </div>
    {% endif %}

    <!-- Back Button -->
    <div class="mt-3">
        <a href="{% url 'admin_geolocation' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Back to Dashboard
        </a>
        <a href="{% url 'admin_settings' %}" class="btn btn-outline-primary">
            <i class="fas fa-cog"></i> Admin Settings
        </a>
    </div>
</div>
{% endblock %}
