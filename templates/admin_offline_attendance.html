{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline Attendance - RollCall</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        .member-search-result {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .member-search-result:hover {
            background-color: #f8f9fa;
        }
        .recent-attendance {
            max-height: 400px;
            overflow-y: auto;
        }
        .offline-badge {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            font-size: 1.1rem;
            padding: 0.75rem 1.25rem;
        }
    </style>
</head>
<body class="bg-light">
    {% csrf_token %}
    
    <!-- Connection Status Badge -->
    <div id="connection-status" class="offline-badge"></div>

    <div class="container py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fa fa-wifi"></i> Offline Attendance Mode</h2>
                        <p class="text-muted">Mark attendance even without internet connection</p>
                    </div>
                    <a href="{% url 'home' %}" class="btn btn-outline-secondary">
                        <i class="fa fa-arrow-left"></i> Back to Dashboard
                    </a>
                </div>
            </div>
        </div>

        <!-- Alert Container -->
        <div id="alert-container"></div>

        <div class="row">
            <!-- Left Column: Mark Attendance -->
            <div class="col-md-7">
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fa fa-check-circle"></i> Mark Attendance</h5>
                    </div>
                    <div class="card-body">
                        <!-- Service Selection -->
                        <div class="mb-4">
                            <label class="form-label"><strong>Select Service</strong></label>
                            <select id="service-select" class="form-select form-select-lg">
                                <option value="">-- Select Service --</option>
                                {% for service in services %}
                                <option value="{{ service.id }}" data-name="{{ service.name }}" data-code="{{ service.code }}">
                                    {{ service.name }} (Code: {{ service.code }})
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Member Search -->
                        <div class="mb-3">
                            <label class="form-label"><strong>Search Member</strong></label>
                            <input 
                                type="text" 
                                id="member-search" 
                                class="form-control form-control-lg" 
                                placeholder="Type name or phone number..."
                                autocomplete="off"
                            >
                        </div>

                        <!-- Search Results -->
                        <div id="search-results" class="list-group mb-3"></div>

                        <!-- Mark Button -->
                        <button id="mark-attendance-btn" class="btn btn-success btn-lg w-100" disabled>
                            <i class="fa fa-check"></i> Mark Present
                        </button>
                    </div>
                </div>

                <!-- Recently Marked Today -->
                <div class="card shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0"><i class="fa fa-list"></i> Today's Attendance (<span id="today-count">0</span>)</h6>
                    </div>
                    <div class="card-body recent-attendance">
                        <div id="today-list">
                            <p class="text-muted text-center">No attendance marked yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Sync Status -->
            <div class="col-md-5">
                <!-- Sync Card -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-warning">
                        <h5 class="mb-0">
                            <i class="fa fa-sync"></i> Sync Status
                            <span id="pending-count" class="badge bg-secondary ms-2">0</span>
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">
                            Attendance marked offline will be stored locally and synced automatically when internet connection is restored.
                        </p>
                        <button id="sync-button" class="btn btn-primary w-100 mb-3" onclick="window.offlineAttendance.syncAll()">
                            <i class="fa fa-sync"></i> Sync Now
                        </button>
                        <button class="btn btn-outline-secondary w-100" onclick="window.offlineAttendance.displayPendingList()">
                            <i class="fa fa-eye"></i> View Pending
                        </button>
                    </div>
                </div>

                <!-- Pending List -->
                <div class="card shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0"><i class="fa fa-clock"></i> Pending Sync</h6>
                    </div>
                    <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                        <div id="pending-list">
                            <p class="text-muted text-center">No pending attendance</p>
                        </div>
                    </div>
                </div>

                <!-- Instructions -->
                <div class="card shadow-sm mt-4">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0"><i class="fa fa-info-circle"></i> How to Use</h6>
                    </div>
                    <div class="card-body">
                        <ol class="mb-0">
                            <li>Select today's service</li>
                            <li>Search for member by name or phone</li>
                            <li>Click member to select them</li>
                            <li>Click "Mark Present"</li>
                            <li>When online, click "Sync Now" to upload</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{% static 'js/offline-attendance.js' %}"></script>
    <script>
        // Cache members and services data on page load
        const members = JSON.parse('{{ members_json|escapejs }}');
        const services = JSON.parse('{{ services_json|escapejs }}');
        
        window.offlineAttendance.cacheMembers(members);
        window.offlineAttendance.cacheServices(services);

        let selectedMember = null;
        let selectedService = null;
        const todayAttendance = [];

        // Service selection
        document.getElementById('service-select').addEventListener('change', function() {
            selectedService = {
                id: this.value,
                name: this.options[this.selectedIndex].dataset.name,
                code: this.options[this.selectedIndex].dataset.code
            };
            updateMarkButton();
        });

        // Member search
        const searchInput = document.getElementById('member-search');
        const searchResults = document.getElementById('search-results');

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            
            if (query.length < 2) {
                searchResults.innerHTML = '';
                return;
            }

            const results = window.offlineAttendance.searchMembers(query);
            
            if (results.length === 0) {
                searchResults.innerHTML = '<div class="list-group-item">No members found</div>';
                return;
            }

            let html = '';
            results.slice(0, 10).forEach(member => {
                html += `
                    <div class="list-group-item member-search-result" onclick="selectMember(${member.id}, '${member.name}', '${member.phone}')">
                        <strong>${member.name}</strong>
                        <br>
                        <small class="text-muted">${member.phone}</small>
                    </div>
                `;
            });
            
            searchResults.innerHTML = html;
        });

        // Select member
        function selectMember(id, name, phone) {
            selectedMember = { id, name, phone };
            searchInput.value = `${name} - ${phone}`;
            searchResults.innerHTML = '';
            updateMarkButton();
        }

        // Update mark button state
        function updateMarkButton() {
            const btn = document.getElementById('mark-attendance-btn');
            btn.disabled = !(selectedMember && selectedService);
        }

        // Mark attendance
        document.getElementById('mark-attendance-btn').addEventListener('click', function() {
            if (!selectedMember || !selectedService) return;

            const attendance = window.offlineAttendance.markAttendance({
                id: selectedMember.id,
                name: selectedMember.name,
                phone: selectedMember.phone,
                service_id: selectedService.id,
                service_name: selectedService.name
            });

            // Add to today's list
            todayAttendance.push(attendance);
            updateTodayList();

            // Reset form
            selectedMember = null;
            searchInput.value = '';
            updateMarkButton();

            // Show success
            window.offlineAttendance.showAlert(
                `âœ“ ${attendance.member_name} marked present for ${selectedService.name}`,
                'success'
            );

            // Update pending list
            window.offlineAttendance.displayPendingList();
        });

        // Update today's attendance list
        function updateTodayList() {
            const container = document.getElementById('today-list');
            const count = document.getElementById('today-count');
            
            count.textContent = todayAttendance.length;

            if (todayAttendance.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No attendance marked yet</p>';
                return;
            }

            let html = '<div class="list-group">';
            todayAttendance.slice().reverse().forEach(item => {
                const syncStatus = item.synced ? 
                    '<span class="badge bg-success">Synced</span>' : 
                    '<span class="badge bg-warning">Pending</span>';
                
                html += `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${item.member_name}</strong>
                                <br>
                                <small class="text-muted">${new Date(item.timestamp).toLocaleTimeString()}</small>
                            </div>
                            ${syncStatus}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        // Display pending list on load
        window.offlineAttendance.displayPendingList();
    </script>
</body>
</html>
