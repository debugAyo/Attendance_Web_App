{% extends 'base.html' %}
{% load static %}

{% block title %}Add Site Location{% endblock %}

{% block extra_css %}
<style>
    #map {
        height: 400px;
        border-radius: 8px;
        cursor: crosshair;
    }
    .coordinate-input {
        font-family: monospace;
        font-size: 0.9rem;
    }
    .radius-preview {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: rgba(13, 110, 253, 0.2);
        border: 2px solid #0d6efd;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto;
    }
    .location-hint {
        background: #e7f3ff;
        border-left: 4px solid #0d6efd;
        padding: 12px;
        border-radius: 4px;
    }
    .gps-status {
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'geofence_list' %}">Site Locations</a></li>
            <li class="breadcrumb-item active">Add New Location</li>
        </ol>
    </nav>

    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white border-0">
                    <h4 class="mb-0">
                        <i class="fas fa-map-marker-alt text-primary"></i> Add New Site Location
                    </h4>
                    <p class="text-muted mb-0 mt-1">Define a geofenced area for GPS-based check-in validation</p>
                </div>
                <div class="card-body">
                    <!-- Location Hint -->
                    <div class="location-hint mb-4">
                        <i class="fas fa-lightbulb text-primary me-2"></i>
                        <strong>Tip:</strong> Click on the map to set the location, or use "Get My Location" for your current position.
                    </div>

                    <form method="post" id="geofenceForm">
                        {% csrf_token %}
                        
                        <!-- Map Section -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-map"></i> Set Location on Map
                            </label>
                            <div id="map" class="mb-2"></div>
                            <div class="d-flex justify-content-between align-items-center">
                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="getCurrentLocation()">
                                    <i class="fas fa-crosshairs"></i> Get My Location
                                </button>
                                <span id="gpsStatus" class="gps-status text-muted">
                                    <i class="fas fa-map-pin"></i> Click map to set location
                                </span>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Basic Info -->
                            <div class="col-md-6 mb-3">
                                <label for="name" class="form-label fw-bold">Location Name *</label>
                                <input type="text" class="form-control" id="name" name="name" 
                                       placeholder="e.g., Main Office, Site A" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="site_type" class="form-label fw-bold">Site Type</label>
                                <select class="form-select" id="site_type" name="site_type">
                                    {% for value, label in site_types %}
                                    <option value="{{ value }}">{{ label }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="description" class="form-label fw-bold">Description</label>
                            <textarea class="form-control" id="description" name="description" rows="2"
                                      placeholder="Additional details about this location..."></textarea>
                        </div>

                        <!-- GPS Coordinates -->
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="latitude" class="form-label fw-bold">Latitude *</label>
                                <input type="number" class="form-control coordinate-input" id="latitude" 
                                       name="latitude" step="0.0000001" min="-90" max="90" required
                                       placeholder="e.g., 9.0820">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="longitude" class="form-label fw-bold">Longitude *</label>
                                <input type="number" class="form-control coordinate-input" id="longitude" 
                                       name="longitude" step="0.0000001" min="-180" max="180" required
                                       placeholder="e.g., 7.4951">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="radius" class="form-label fw-bold">Radius (meters)</label>
                                <input type="number" class="form-control" id="radius" name="radius" 
                                       value="100" min="10" max="10000">
                                <small class="text-muted">Check-in allowed within this distance</small>
                            </div>
                        </div>

                        <!-- Address Fields -->
                        <hr class="my-4">
                        <h6 class="mb-3"><i class="fas fa-home"></i> Address Information (Optional)</h6>
                        
                        <div class="mb-3">
                            <label for="address" class="form-label">Street Address</label>
                            <input type="text" class="form-control" id="address" name="address"
                                   placeholder="Street address">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="state" class="form-label">State/Province</label>
                                <input type="text" class="form-control" id="state" name="state">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="country" class="form-label">Country</label>
                                <input type="text" class="form-control" id="country" name="country">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="postal_code" class="form-label">Postal Code</label>
                                <input type="text" class="form-control" id="postal_code" name="postal_code">
                            </div>
                        </div>

                        <!-- Settings -->
                        <hr class="my-4">
                        <h6 class="mb-3"><i class="fas fa-cog"></i> Settings</h6>
                        
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="is_active" 
                                           name="is_active" checked>
                                    <label class="form-check-label" for="is_active">
                                        <strong>Active</strong>
                                        <br><small class="text-muted">Accept check-ins at this location</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="require_gps" 
                                           name="require_gps" checked>
                                    <label class="form-check-label" for="require_gps">
                                        <strong>Require GPS</strong>
                                        <br><small class="text-muted">Must verify location via GPS</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="allow_remote" 
                                           name="allow_remote">
                                    <label class="form-check-label" for="allow_remote">
                                        <strong>Allow Remote</strong>
                                        <br><small class="text-muted">Allow check-ins outside geofence</small>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between mt-4">
                            <a href="{% url 'geofence_list' %}" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Cancel
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Location
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Preview Panel -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0"><i class="fas fa-eye"></i> Preview</h5>
                </div>
                <div class="card-body text-center">
                    <div class="radius-preview mb-3">
                        <span id="radiusDisplay">100m</span>
                    </div>
                    <p class="text-muted small">
                        Users must be within <strong id="radiusText">100 meters</strong> of the location to check in.
                    </p>
                    
                    <hr>
                    
                    <div class="text-start">
                        <p class="mb-2"><strong>Coordinates:</strong></p>
                        <code id="coordsDisplay" class="d-block mb-3">Not set</code>
                        
                        <p class="mb-2"><strong>Accuracy:</strong></p>
                        <div class="progress mb-2" style="height: 8px;">
                            <div class="progress-bar bg-success" id="accuracyBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="accuracyText">Set location to see accuracy</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Google Maps JS -->
<script>
let map;
let marker;
let circle;

// Initialize map
function initMap() {
    // Default to Minna, Niger State, Nigeria (Gidan Kwano area)
    const defaultCenter = { lat: 9.5366, lng: 6.4569 };
    
    map = new google.maps.Map(document.getElementById('map'), {
        center: defaultCenter,
        zoom: 14,
        mapTypeId: 'hybrid',  // Satellite + labels for precision
        mapTypeControl: true,
        mapTypeControlOptions: {
            style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
            mapTypeIds: ['roadmap', 'satellite', 'hybrid', 'terrain']
        },
        streetViewControl: true,
        fullscreenControl: true
    });
    
    // Click to set location
    map.addListener('click', function(e) {
        setLocation(e.latLng.lat(), e.latLng.lng());
    });
}

function setLocation(lat, lng) {
    // Update form fields with high precision
    document.getElementById('latitude').value = lat.toFixed(7);
    document.getElementById('longitude').value = lng.toFixed(7);
    
    const position = { lat: lat, lng: lng };
    
    // Update or create marker
    if (marker) {
        marker.setPosition(position);
    } else {
        marker = new google.maps.Marker({
            position: position,
            map: map,
            draggable: true,
            animation: google.maps.Animation.DROP,
            icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 12,
                fillColor: '#0d6efd',
                fillOpacity: 1,
                strokeColor: '#ffffff',
                strokeWeight: 3
            }
        });
        
        // Allow dragging to fine-tune position
        marker.addListener('dragend', function(e) {
            setLocation(e.latLng.lat(), e.latLng.lng());
        });
    }
    
    // Update or create circle for radius visualization
    const radius = parseInt(document.getElementById('radius').value) || 100;
    if (circle) {
        circle.setCenter(position);
        circle.setRadius(radius);
    } else {
        circle = new google.maps.Circle({
            strokeColor: '#0d6efd',
            strokeOpacity: 0.8,
            strokeWeight: 2,
            fillColor: '#0d6efd',
            fillOpacity: 0.2,
            map: map,
            center: position,
            radius: radius
        });
    }
    
    // Center and zoom map for precision
    map.setCenter(position);
    map.setZoom(18);
    
    // Update preview
    document.getElementById('coordsDisplay').textContent = `${lat.toFixed(7)}, ${lng.toFixed(7)}`;
    document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-check-circle text-success"></i> Location set (drag marker to adjust)';
    document.getElementById('accuracyBar').style.width = '100%';
    document.getElementById('accuracyText').textContent = 'Location selected';
    
    // Try to get address via reverse geocoding
    reverseGeocode(lat, lng);
}

function getCurrentLocation() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by your browser');
        return;
    }
    
    document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-spinner fa-spin"></i> Getting precise location...';
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            setLocation(position.coords.latitude, position.coords.longitude);
            
            // Show accuracy info
            const accuracy = position.coords.accuracy;
            document.getElementById('accuracyText').textContent = `GPS accuracy: Â±${accuracy.toFixed(0)}m`;
            
            // Calculate accuracy percentage (lower distance = better)
            const accuracyPercent = Math.max(0, Math.min(100, 100 - (accuracy / 5)));
            document.getElementById('accuracyBar').style.width = accuracyPercent + '%';
            
            if (accuracy <= 10) {
                document.getElementById('accuracyBar').className = 'progress-bar bg-success';
                document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-check-circle text-success"></i> Excellent GPS accuracy!';
            } else if (accuracy <= 50) {
                document.getElementById('accuracyBar').className = 'progress-bar bg-info';
                document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-check-circle text-info"></i> Good GPS accuracy';
            } else {
                document.getElementById('accuracyBar').className = 'progress-bar bg-warning';
                document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-exclamation-triangle text-warning"></i> Moderate accuracy - drag marker to fine-tune';
            }
        },
        function(error) {
            document.getElementById('gpsStatus').innerHTML = '<i class="fas fa-exclamation-triangle text-danger"></i> GPS error: ' + error.message;
            alert('Error getting location: ' + error.message + '\n\nTry:\n1. Enable location services\n2. Use HTTPS (required for GPS)\n3. Click on the map to set location manually');
        },
        {
            enableHighAccuracy: true,  // Use GPS for best accuracy
            timeout: 15000,
            maximumAge: 0  // Don't use cached position
        }
    );
}

function reverseGeocode(lat, lng) {
    // Use Google's Geocoder for reverse geocoding
    const geocoder = new google.maps.Geocoder();
    geocoder.geocode({ location: { lat: lat, lng: lng } }, function(results, status) {
        if (status === 'OK' && results[0]) {
            // Parse address components
            const address = results[0];
            let street = '', city = '', state = '', country = '', postal = '';
            
            address.address_components.forEach(component => {
                if (component.types.includes('route')) street = component.long_name;
                if (component.types.includes('street_number')) street = component.long_name + ' ' + street;
                if (component.types.includes('locality')) city = component.long_name;
                if (component.types.includes('administrative_area_level_1')) state = component.long_name;
                if (component.types.includes('country')) country = component.long_name;
                if (component.types.includes('postal_code')) postal = component.long_name;
            });
            
            // Fill in address fields
            if (street) document.getElementById('address').value = street.trim();
            if (city) document.getElementById('city').value = city;
            if (state) document.getElementById('state').value = state;
            if (country) document.getElementById('country').value = country;
            if (postal) document.getElementById('postal_code').value = postal;
        }
    });
}

// Update radius preview and circle
document.getElementById('radius').addEventListener('input', function() {
    const radius = parseInt(this.value) || 100;
    document.getElementById('radiusDisplay').textContent = radius + 'm';
    document.getElementById('radiusText').textContent = radius + ' meters';
    
    if (circle) {
        circle.setRadius(radius);
    }
});

// Update map when coordinates are manually entered
document.getElementById('latitude').addEventListener('change', updateFromInputs);
document.getElementById('longitude').addEventListener('change', updateFromInputs);

function updateFromInputs() {
    const lat = parseFloat(document.getElementById('latitude').value);
    const lng = parseFloat(document.getElementById('longitude').value);
    
    if (!isNaN(lat) && !isNaN(lng) && lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180) {
        setLocation(lat, lng);
    }
}

// Load Google Maps API
function loadGoogleMaps() {
    const apiKey = '{{ google_maps_api_key|default:"" }}';
    const script = document.createElement('script');
    script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMap`;
    script.async = true;
    script.defer = true;
    document.head.appendChild(script);
}

document.addEventListener('DOMContentLoaded', loadGoogleMaps);
</script>
{% endblock %}
